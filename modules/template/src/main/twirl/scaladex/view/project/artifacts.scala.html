@import scaladex.core.model._
@import scaladex.view.html.main
@import scaladex.view.html._
@import scaladex.core.web.ArtifactsPageParams
@import scaladex.core.model.Language
@import scaladex.core.model.Platform
@import scala.collection.SortedMap
@import scaladex.core.util.ScalaExtensions._
@import scaladex.core.util.TimeUtils
@import scaladex.view.Formats

@import java.time.Instant

@(
    env: Env,
    user: Option[UserState],
    project: Project,
    header: Option[ProjectHeader],
    groupedArtifacts: Map[SemanticVersion, Map[Artifact.Name, Seq[Artifact]]]
)

@main(env, title = project.repository.toString, user) {
  <main id="container-project">
    @headproject(env, user, project, header, "Artifacts")
    <div class="container">
      <div class="content-project artifacts box" data-organization="@project.reference.organization"
      data-repository="@project.reference.repository">
        <div class="artifacts-filter">
          @filters()
          <div class="result-count">
            <b>@groupedArtifacts.values.flatten.size</b> @Formats.wordPlural(groupedArtifacts.values.flatten.size, "artifact") found
          </div>
        </div>
        @if(groupedArtifacts.isEmpty) {
          <div>We can't find any artifacts for this project.</div>
        } else {
          <div>
            @for((version, artifactsByName) <- groupedArtifacts.toSeq.sortBy(_._1).reverse) {
              <h3>Version @version</h3>
              @for((artifactName, artifacts) <- artifactsByName.toSeq.sortBy(_._1)) {
                <div class="panel">
                  <div class="artifact-row panel-body center">
                    <div class="col-md-3 center">
                      <a class="artifact-version" href="/@project.reference/artifacts/@artifactName">@artifactName</a>
                    </div>
                    <div class="col-md-9">
                      <div class="artifact-info">
                        <a data-toggle="tooltip" data-placement="top" title="@formatInstant(artifacts.head.releaseDate)">
                          @TimeUtils.toFiniteDuration(artifacts.head.releaseDate, Instant.now()).prettyPrint
                          ago<i class="fa-solid fa-calendar-days"></i>
                        </a>
                        <br>
                        @artifacts.head.licenses.map { license =>
                          <a href="@license.url.getOrElse("#")">@license.shortName<i class="fa-solid fa-scale-balanced"></i></a>
                        }
                      </div>
                      <div class="artifact-content">
                        @for(
                          (platform, binaryVersions) <- artifacts
                            .groupBy(_.platform)
                            .toSeq
                            .sortBy(_._1)
                            .reverse
                        ) {
                          <h5>@platform:</h5>
                          @for(binaryVersion <- binaryVersions.map(_.binaryVersion).distinct.sorted.reverse) { 
                            <a href="/@project.reference/artifacts/@artifactName/@version?binary-version=@binaryVersion.encode" class="scala-version">
                              @binaryVersion.language.label
                            </a>
                          }
                          <br>
                        }
                      </div>
                    </div>
                  </div>
                </div>
              }
            }
          </div>
        }
      </div>
    </div>
  </main>
}
@filters() = {
  <form action="#" action="GET"> 
    <select class="selectpicker" name="binary-versions" 
      title="Scala Versions" multiple data-style="btn-primary" data-actions-box="true" data-selected-text-format="static"
      onchange="this.form.submit()">
      @for((platform, binaryVersions) <- groupedArtifacts.values.flatten.flatMap(_._2).map(_.binaryVersion).toSeq.distinct.groupBy(_.platform).toSeq.sortBy(_._1).reverse) {
        <optgroup label="@platform">
          @for(binaryVersion <- binaryVersions) {
            <option value="@binaryVersion.label">
              @binaryVersion.language.label
            </option>
          }
        </optgroup>
      }
    </select>
  </form>
}
