@import scaladex.view.Job
@import scaladex.view.html._
@import scaladex.core.model.UserState
@import scaladex.core.model.Env
@import scaladex.core.util.ScalaExtensions._

@import scaladex.view.AdminTaskStatus

@(env: Env, user: UserState, jobStatuses: Seq[(Job, Job.Status)], adminTaskStatus: Seq[AdminTaskStatus])
@main(env, title = "Admin page", Some(user)) {
  <div class="container admin-content">
    <h2>Background jobs</h2>
    <table class="table">
      <thead>
        <tr>
          <th scope="col">Job</th>
          <th scope="col">Status</th>
          <th scope="col">Results</th>
          <th scope="col">Progress</th>
          <th scope="col">Action</th>
        </tr>
      </thead>
      <tbody>
        @jobStatuses.map { case (job, status) =>
          <tr>
            <td>
              <h5>@job.name <small>every @job.frequency.shortPrint</small></h5>
              <p>@job.description</p>
            </th>
            <td>@stateCell(status.state)</td>
            <td>@resultsCell(status.results)</td>
            <td>
              @status.progress match {
                case Some(progress) => {
                  @progressBar(progress)
                }
                case None => {
                  <div style="text-align: center;">-</div>
                }
              }
            </td>
            <td>
              @if(status.isStarted) {
                <form action="/admin/@{job.name}/stop" method="post">
                  <button type="submit" class="btn btn-danger">Stop</button>
                </form>
              } else {
                <form action="/admin/@{job.name}/start" method="post">
                  <button type="submit" class="btn btn-success">Start</button>
                </form>
              }
            </td>
          </tr>
        }
      </tbody>
    </table>
    <h2>Admin tasks</h2>
    <table class="table">
      <thead>
        <tr>
          <th scope="col">Admin task</th>
          <th scope="col">Form</th>
          <th scope="col">Action</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <th scope="row">Index artifacts</th>
          <form action="/admin/index" method="POST">
            <td>
              <div class="row">
                <div class="col-lg-6">
                  <div class="input-group">
                    <span class="input-group-addon" id="group-id">GroupID</span>
                    <input type="text" class="form-control" name="group-id" placeholder="Ex: ch.epfl.scala" required>
                  </div>
                </div>
                <div class="col-lg-6">
                  <div class="input-group">
                    <span class="input-group-addon" id="group-id">Artifact Name (optional)</span>
                    <input type="text" class="form-control" name="artifact-name" placeholder="Ex: scalafix-core">
                  </div>
                </div>
              </div>
            </td>
            <td><button type="submit" class="btn btn-primary">Submit</button></td>
          </form>
        </tr>
      </tbody>
    </table>
    <h2>Admin tasks Status</h2>
    <table class="table">
      <thead>
        <tr>
          <th scope="col">Admin task Name</th>
          <th scope="col">Status</th>
          <th scope="col">created by</th>
          <th scope="col">Created</th>
          <th scope="col">Started</th>
          <th scope="col">Succeeded</th>
          <th scope="col">Failed</th>
        </tr>
      </thead>
      <tbody>
        @adminTaskStatus.map { task =>
          <tr>
            <th scope="row">@task.name</th>
            <td>@task.status</td>
            <td>@task.createdBy</td>
            <td>@formatInstant(task.created)</td>
            <td>@formatInstant(task.startedTime)</td>
            <td>@formatInstant(task.succeededTime)</td>
            <td>
              @task.failedTimeWithErrorMessage
                .map{ case (time, error) => s"failed because $error at ${formatInstant(time)}"}
                .getOrElse("_")
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>
}

@progressBar(progress: Job.Progress) = {
  <div class="progress">
    <div class="progress-bar progress-bar-info" role="progressbar" aria-valuenow="@progress.percentage" aria-valuemin="0" aria-valuemax="100" style="width: @progress.percentage%">
      @{progress.duration.shortPrint} (@{progress.percentage.round} %)
    </div>
  </div>
}

@stateCell(state: Job.State) = {
  @state match {
    case Job.Started(_, user) => {
      Started @user.map(u => s" by $u").getOrElse("") @state.fromNow.shortPrint ago
    }
    case Job.Stopped(_, user) => {
      Stopped @user.map(u => s" by $u").getOrElse("") @state.fromNow.shortPrint ago
    }
  }
}

@resultsCell(results: Seq[Job.Result]) = {
  <ul>
    @for(result <- results.reverse.take(3)) {
      <li>
        @result match {
          case success: Job.Success => {
            <h6>Success <small>@success.fromNow.shortPrint ago - @success.duration.shortPrint</small></h6>
            <p>@success.message</p>
            
          }
          case failure: Job.Failure => {
            <h6>Failure <small>@failure.fromNow.shortPrint ago - @failure.duration.shortPrint</small></h6>
            <p>@failure.cause</p>
          }
        }
      </li>
    }
  </ul>
}
